<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wajah, Mata & Iris</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <style>
    video, canvas {
      display: block;
      margin: 10px auto;
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 10px #aaa;
    }
    button {
      margin: 5px;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Deteksi Wajah, Mata dan Iris</h2>
  <button id="startBtn">Start Camera</button>
  <button id="switchBtn">Switch Camera</button>
  <button id="captureBtn">Capture</button>
  <br>
  <video id="video" width="480" height="360" autoplay playsinline></video>
  <br>
  <canvas id="canvas" width="480" height="360"></canvas>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let currentFacingMode = "environment";
    let stream = null;
    let faceCascade, eyeCascade;

    // Load cascades
    async function loadCascades() {
      faceCascade = new cv.CascadeClassifier();
      eyeCascade = new cv.CascadeClassifier();
      await faceCascade.load('haarcascade_frontalface_default.xml');
      await eyeCascade.load('haarcascade_eye.xml');
      console.log("Cascades loaded");
    }

    // Start camera
    async function startCamera(facingMode = "environment") {
      try {
        if (stream) stream.getTracks().forEach(track => track.stop());
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode },
          audio: false
        });
        video.srcObject = stream;
        currentFacingMode = facingMode;
      } catch (err) {
        alert("Camera error: " + err.message);
      }
    }

    // Switch camera
    document.getElementById('switchBtn').onclick = () => {
      const newMode = currentFacingMode === "environment" ? "user" : "environment";
      startCamera(newMode);
    };

    document.getElementById('startBtn').onclick = () => startCamera();
    document.getElementById('captureBtn').onclick = captureFrame;

    async function captureFrame() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.equalizeHist(gray, gray);

      let faces = new cv.RectVector();
      faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0);

      for (let i = 0; i < faces.size(); i++) {
        let face = faces.get(i);
        let faceROI = gray.roi(face);

        // Draw face rectangle
        cv.rectangle(src, new cv.Point(face.x, face.y), 
                          new cv.Point(face.x + face.width, face.y + face.height), 
                          [255, 0, 0, 255], 2);

        // Upper half of face only
        let upperFaceROI = faceROI.roi(new cv.Rect(0, 0, face.width, face.height / 2));
        let eyes = new cv.RectVector();
        eyeCascade.detectMultiScale(upperFaceROI, eyes, 1.1, 3, 0);

        // Convert to array for filtering
        let eyeRects = [];
        for (let j = 0; j < eyes.size(); j++) eyeRects.push(eyes.get(j));
        eyeRects.sort((a, b) => a.x - b.x); // sort left-to-right
        eyeRects = eyeRects.slice(0, 2);    // max 2 eyes

        for (let eye of eyeRects) {
          let ex = face.x + eye.x;
          let ey = face.y + eye.y;
          cv.rectangle(src, new cv.Point(ex, ey),
                            new cv.Point(ex + eye.width, ey + eye.height),
                            [0, 0, 255, 255], 2);

          // Detect iris (dark circle) using HoughCircles
          let eyeROI = upperFaceROI.roi(eye);
          let circles = new cv.Mat();
          cv.GaussianBlur(eyeROI, eyeROI, new cv.Size(7, 7), 0);
          cv.HoughCircles(eyeROI, circles, cv.HOUGH_GRADIENT, 1, eyeROI.rows/8, 100, 15, eyeROI.rows/8, eyeROI.rows/3);

          for (let k = 0; k < circles.cols; k++) {
            let x = circles.data32F[k * 3];
            let y = circles.data32F[k * 3 + 1];
            let radius = circles.data32F[k * 3 + 2];
            cv.circle(src, new cv.Point(ex + x, ey + y), radius, [0, 255, 0, 255], 2);
            cv.circle(src, new cv.Point(ex + x, ey + y), 2, [0, 255, 0, 255], -1);
          }

          circles.delete(); eyeROI.delete();
        }

        upperFaceROI.delete(); faceROI.delete(); eyes.delete();
      }

      cv.imshow(canvas, src);
      src.delete(); gray.delete(); faces.delete();
    }

    // Load cascades after OpenCV is ready
    cv['onRuntimeInitialized'] = async () => {
      await loadCascades();
      console.log("Ready!");
    };
  </script>
</body>
</html>
